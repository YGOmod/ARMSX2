name: Android Nightly Debug Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 

    steps:
      - name: â¬‡ï¸ Checkout of code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
        
      - name: ðŸ› ï¸ Java and Android SDK Setup
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: âš™ï¸ Setup of Gradle Wrapper
        uses: gradle/actions/setup-gradle@v3

      # --- Build Phase ---
      - name: ðŸ—ï¸ Running the Debug Build (only Nightly)
        run: ./gradlew assembleUnrestrictedDebug

      - name: ðŸ”Ž Get Package Name and Version
        id: package_info
        run: |
          PACKAGE_NAME=$(grep 'applicationId' app/build.gradle | head -n 1 | awk '{print $2}' | tr -d '"')
          VERSION_NAME=$(grep 'versionName' app/build.gradle | head -n 1 | awk '{print $2}' | tr -d '"')
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ·ï¸ Defining the Release Tag and Title
        id: release_vars
        run: |
          # The release tag will be in the format: come.nanodata.armsx2-nightly-1.0.4-20251104-1411
          DATE_TIME=$(date +%Y%m%d-%H%M)
          FULL_TAG="${{ steps.package_info.outputs.PACKAGE_NAME }}-nightly-${{ steps.package_info.outputs.VERSION_NAME }}-${DATE_TIME}"
          TITLE="Nightly Build (DEBUG - ${{ steps.package_info.outputs.VERSION_NAME }}) - ${DATE_TIME}"
          
          echo "RELEASE_TAG=$FULL_TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Find and Rename APK to Nightly
        id: rename_apk
        run: |
          ORIGINAL_PATH=$(find ${{ github.workspace }}/app/build -type f -name "*debug.apk" -print -quit)
          if [ -z "$ORIGINAL_PATH" ]; then
            echo "CRITICAL ERROR: Debug APK non found."
            exit 1 
          fi
          NEW_FILE_PATH=$(echo "$ORIGINAL_PATH" | sed 's/-debug.apk/-nightly.apk/')
          mv "$ORIGINAL_PATH" "$NEW_FILE_PATH"
          echo "APK_FILE_NIGHTLY=$NEW_FILE_PATH" >> $GITHUB_OUTPUT
          echo "APK renamed and saved in: $NEW_FILE_PATH"

      - name: ðŸš€ Create the Release on GitHub
        uses: softprops/action-gh-release@v2
        if: >
          github.repository == 'ARMSX2/ARMSX2' &&
          github.ref == 'refs/heads/master'
        with:
          tag_name: ${{ steps.release_vars.outputs.RELEASE_TAG }}
          name: ${{ steps.release_vars.outputs.RELEASE_TITLE }}
          body: |
            ## Automatic Night Release (DEBUG)
            
            Automated build for community testing. This is an **unsigned** build for public distribution.
            
            * **Version:** ${{ steps.package_info.outputs.VERSION_NAME }}
            * **Package Name:** ${{ steps.package_info.outputs.PACKAGE_NAME }}
            * **Branch:** ${{ github.ref_name }}
            * **Commit:** ${{ github.sha }}
            
            **Check the attached assets for the NIGHTLY APK.**
          draft: false
          prerelease: true
          files: ${{ steps.rename_apk.outputs.APK_FILE_NIGHTLY }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}